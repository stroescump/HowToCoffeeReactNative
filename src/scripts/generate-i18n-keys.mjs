// src/scripts/generate-i18n-keys.mjs
// AUTO-GENERATES src/i18n/strings.ts FROM your JSON resources.
// DO NOT EDIT THE GENERATED FILE MANUALLY.

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Adjust these if your structure changes
const LOCALES_DIR = path.resolve(__dirname, "../i18n/locales");
const OUTPUT_FILE = path.resolve(__dirname, "../i18n/strings.ts");
const BASE_LANG = "en";           // we use "en" as the source of truth for keys

const jsonPath = path.join(LOCALES_DIR, BASE_LANG, "common.json");

if (!fs.existsSync(jsonPath)) {
  console.error(`[generate-i18n-keys] Could not find ${jsonPath}`);
  process.exit(1);
}

const raw = fs.readFileSync(jsonPath, "utf8");
const data = JSON.parse(raw);

/**
 * Recursively transforms the JSON into an object where each leaf
 * is the FULL i18n key, like "common.steps.dose.title".
 */
function buildKeyObject(obj, pathSegments = []) {
  const result = {};

  for (const [key, value] of Object.entries(obj)) {
    const newPath = [...pathSegments, key];

    if (value && typeof value === "object" && !Array.isArray(value)) {
      result[key] = buildKeyObject(value, newPath);
    } else {
      result[key] = newPath.join(".");
    }
  }

  return result;
}

const keysObj = buildKeyObject(data);

const fileContent = `// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.
// Generated by src/scripts/generate-i18n-keys.mjs

export const StringRes = ${JSON.stringify(keysObj, null, 2)} as const;

// Deep type helper to extract all string values from nested objects
type LeafValues<T> = T extends string
  ? T
  : T extends Record<string, any>
  ? LeafValues<T[keyof T]>
  : never;

export type TranslationKey = LeafValues<typeof StringRes>;
`;

fs.writeFileSync(OUTPUT_FILE, fileContent, "utf8");
console.log(`[generate-i18n-keys] Wrote: ${OUTPUT_FILE}`);